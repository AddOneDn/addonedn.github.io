<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ICS2017 Programming Assignment 2.2-2.3"><meta name="keywords" content="学习,C"><meta name="author" content="AddOneG,undefined"><meta name="copyright" content="AddOneG"><title>ICS2017 Programming Assignment 2.2-2.3 | AddOneG</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: undefined
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PA2-2-程序，运行时的环境与AM"><span class="toc-number">1.</span> <span class="toc-text">PA2.2 程序，运行时的环境与AM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#运行更多的程序"><span class="toc-number">1.1.</span> <span class="toc-text">运行更多的程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现更多的指令"><span class="toc-number">1.1.1.</span> <span class="toc-text">实现更多的指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#完成指令"><span class="toc-number">1.1.2.</span> <span class="toc-text">完成指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#all-instr-h"><span class="toc-number">1.1.3.</span> <span class="toc-text">all-instr.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#arith-c"><span class="toc-number">1.1.4.</span> <span class="toc-text">arith.c</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Add"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Sub"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">Sub</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cmp"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">Cmp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Inc"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">Inc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Dec"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">Dec</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Neg"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">Neg</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#control-c"><span class="toc-number">1.1.5.</span> <span class="toc-text">control.c</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ret"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">ret</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#data-mov-c"><span class="toc-number">1.1.6.</span> <span class="toc-text">data-mov.c</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#leave"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">leave</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cltd"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">cltd</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#logic-c"><span class="toc-number">1.1.7.</span> <span class="toc-text">logic.c</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#test"><span class="toc-number">1.1.7.1.</span> <span class="toc-text">test</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#and"><span class="toc-number">1.1.7.2.</span> <span class="toc-text">and</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#or"><span class="toc-number">1.1.7.3.</span> <span class="toc-text">or</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sar"><span class="toc-number">1.1.7.4.</span> <span class="toc-text">sar</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setcc"><span class="toc-number">1.1.7.5.</span> <span class="toc-text">setcc</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cc-c"><span class="toc-number">1.1.8.</span> <span class="toc-text">cc.c</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基础设置-2"><span class="toc-number">1.2.</span> <span class="toc-text">基础设置(2)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#思考题"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">思考题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Differential-Testing"><span class="toc-number">1.2.1.</span> <span class="toc-text">Differential Testing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一键回归测试"><span class="toc-number">1.2.2.</span> <span class="toc-text">一键回归测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#思考题-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">思考题</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PA2-3-输入输出"><span class="toc-number">2.</span> <span class="toc-text">PA2.3 输入输出</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#思考题-2"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">思考题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现Hello-World"><span class="toc-number">2.0.1.</span> <span class="toc-text">实现Hello World</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#时钟"><span class="toc-number">2.0.2.</span> <span class="toc-text">时钟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#看看NEMU跑多快"><span class="toc-number">2.0.3.</span> <span class="toc-text">看看NEMU跑多快</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#键盘"><span class="toc-number">2.0.4.</span> <span class="toc-text">键盘</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#思考题-3"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">思考题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加内存映射I-O"><span class="toc-number">2.0.5.</span> <span class="toc-text">添加内存映射I/O</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实现IOE-3"><span class="toc-number">2.0.6.</span> <span class="toc-text">实现IOE(3)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#必答题"><span class="toc-number">2.0.7.</span> <span class="toc-text">必答题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#编译与链接"><span class="toc-number">2.0.7.1.</span> <span class="toc-text">编译与链接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编译与链接-1"><span class="toc-number">2.0.7.2.</span> <span class="toc-text">编译与链接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#了解Makefile"><span class="toc-number">2.0.7.3.</span> <span class="toc-text">了解Makefile</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://p5sf6v0wz.bkt.clouddn.com/avatar.jpg"></div><div class="author-info__name text-center">AddOneG</div><div class="author-info__description text-center">我本嘉宾，何惧无笙</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">39</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">30</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">21</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://blog.triplez.cn/" target="_blank">TripleZ</a><a class="author-info-links__name text-center" href="http://karlrixon.link/" target="_blank">karlrixon</a><a class="author-info-links__name text-center" href="http://qrzbing.cn/" target="_blank">a-Lie-Z</a><a class="author-info-links__name text-center" href="https://primykq.top/" target="_blank">Primykq</a><a class="author-info-links__name text-center" href="https://blog.zeddyu.info/" target="_blank">Zedd</a><a class="author-info-links__name text-center" href="https://yuwenjie.cc/" target="_blank">Seiry</a><a class="author-info-links__name text-center" href="https://mountainlovers.github.io/" target="_blank">Mountain_lovers</a><a class="author-info-links__name text-center" href="https://blog.rexskz.info/" target="_blank">Rex</a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">AddOneG</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">时间轴</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">ICS2017 Programming Assignment 2.2-2.3</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/C/"> C</a><span class="post-meta__separator">|</span><span class="post-meta-wordcount"><span>Word count: </span><span class="word-count">6,057</span><span class="post-meta__separator">|</span><span>Reading time: 29 min</span></span></div><div id="post-content"><h2 id="PA2-2-程序，运行时的环境与AM"><a href="#PA2-2-程序，运行时的环境与AM" class="headerlink" title="PA2.2 程序，运行时的环境与AM"></a>PA2.2 程序，运行时的环境与AM</h2><h3 id="运行更多的程序"><a href="#运行更多的程序" class="headerlink" title="运行更多的程序"></a>运行更多的程序</h3><p>让项目默认编译到<code>x86-nemu</code>中的AM中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nexus-am/Makefile.check</span></span><br><span class="line">ARCH ?= x86-nemu</span><br><span class="line"></span><br><span class="line">ARCHS = $(shell ls $(AM_HOME)/am/arch/)</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>nexus-am/tests/cputest</code>中执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ALL=xxx run</span><br></pre></td></tr></table></figure>
<blockquote>
<p>xxx为程序名(无.c后缀)</p>
</blockquote>
<h4 id="实现更多的指令"><a href="#实现更多的指令" class="headerlink" title="实现更多的指令"></a>实现更多的指令</h4><p>在完成更多指令之前我们要先完成<code>rtl.h</code>中的辅助函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> make_rtl_setget_eflags(f) \</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">concat</span><span class="params">(rtl_set_, f)</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">rtlreg_t</span>* src)</span> </span>&#123; \</span><br><span class="line">    cpu.eflags.f = *src;  \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">concat</span><span class="params">(rtl_get_, f)</span> <span class="params">(<span class="keyword">rtlreg_t</span>* dest)</span> </span>&#123; \</span><br><span class="line">    *dest = cpu.eflags.f; \</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>根据提示简单的完成标志位赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rtl_not</span><span class="params">(<span class="keyword">rtlreg_t</span>* dest)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// dest &lt;- ~dest</span></span><br><span class="line">  rtl_li(dest,~(*dest));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取反</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rtl_update_ZF</span><span class="params">(<span class="keyword">const</span> <span class="keyword">rtlreg_t</span>* result, <span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// eflags.ZF &lt;- is_zero(result[width * 8 - 1 .. 0])</span></span><br><span class="line">    assert (width == <span class="number">4</span> || width == <span class="number">2</span> || width == <span class="number">1</span>);</span><br><span class="line">    cpu.eflags.ZF = (*result &amp; ~(<span class="number">0xffffffff</span> &lt;&lt; (<span class="number">8</span> * width - <span class="number">1</span>) &lt;&lt; <span class="number">1</span>)) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据提示更新<code>ZF</code>位，同时判断长度<code>width</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rtl_update_SF</span><span class="params">(<span class="keyword">const</span> <span class="keyword">rtlreg_t</span>* result, <span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// eflags.SF &lt;- is_sign(result[width * 8 - 1 .. 0])</span></span><br><span class="line"> assert (width == <span class="number">4</span> || width == <span class="number">2</span> || width == <span class="number">1</span>);</span><br><span class="line"> cpu.eflags.SF = (*result &gt;&gt; (<span class="number">8</span> * width - <span class="number">1</span>)) &amp; <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据提示更新<code>SF</code>位，同时判断长度<code>width</code></p>
<h4 id="完成指令"><a href="#完成指令" class="headerlink" title="完成指令"></a>完成指令</h4><p>主要任务是完成<code>nemu/src/cpu/exec/</code>下每个文件的<code>TODO</code>，先在该目录下执行<code>ls</code>看一下文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all-instr.h  arith.c  cc.c  control.c  data-mov.c  exec.c  logic.c  prefix.c  special.c  system.c</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接下来我们按<code>ls</code>展示的文件顺序进行分析</p>
</blockquote>
<h4 id="all-instr-h"><a href="#all-instr-h" class="headerlink" title="all-instr.h"></a>all-instr.h</h4><p><code>all-instr.h</code>为你写的函数定义的文件，先看看在文件完成后定义的全部指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"cpu/exec.h"</span></span><br><span class="line"></span><br><span class="line">make_EHelper(mov);</span><br><span class="line"></span><br><span class="line">make_EHelper(operand_size);</span><br><span class="line"></span><br><span class="line">make_EHelper(cltd);</span><br><span class="line">make_EHelper(cwtl);</span><br><span class="line">make_EHelper(idiv);</span><br><span class="line">make_EHelper(div);</span><br><span class="line">make_EHelper(sbb);</span><br><span class="line">make_EHelper(dec);</span><br><span class="line">make_EHelper(shl);</span><br><span class="line">make_EHelper(sar);</span><br><span class="line">make_EHelper(<span class="keyword">or</span>);</span><br><span class="line">make_EHelper(adc);</span><br><span class="line">make_EHelper(dec);</span><br><span class="line">make_EHelper(mul);</span><br><span class="line">make_EHelper(imul);</span><br><span class="line">make_EHelper(imul1);</span><br><span class="line">make_EHelper(imul2);</span><br><span class="line">make_EHelper(jmp_rm);</span><br><span class="line">make_EHelper(jmp);</span><br><span class="line">make_EHelper(inc);</span><br><span class="line">make_EHelper(leave);</span><br><span class="line">make_EHelper(cltd);</span><br><span class="line">make_EHelper(jcc);</span><br><span class="line">make_EHelper(test);</span><br><span class="line">make_EHelper(movzx);</span><br><span class="line">make_EHelper(movsx);</span><br><span class="line">make_EHelper(setcc);</span><br><span class="line">make_EHelper(nop);</span><br><span class="line">make_EHelper(xchg);</span><br><span class="line">make_EHelper(<span class="keyword">and</span>);</span><br><span class="line">make_EHelper(leave);</span><br><span class="line">make_EHelper(cltd);</span><br><span class="line">make_EHelper(dec);</span><br><span class="line">make_EHelper(cmp);</span><br><span class="line">make_EHelper(neg);</span><br><span class="line">make_EHelper(<span class="keyword">not</span>);</span><br><span class="line">make_EHelper(<span class="keyword">or</span>);</span><br><span class="line">make_EHelper(shr);</span><br><span class="line">make_EHelper(sar);</span><br><span class="line">make_EHelper(lea);</span><br><span class="line">make_EHelper(add);</span><br><span class="line">make_EHelper(inv);</span><br><span class="line">make_EHelper(nemu_trap);</span><br><span class="line">make_EHelper(call);</span><br><span class="line">make_EHelper(call_rm);</span><br><span class="line">make_EHelper(push);</span><br><span class="line">make_EHelper(sub);</span><br><span class="line">make_EHelper(pop);</span><br><span class="line">make_EHelper(xor);</span><br><span class="line">make_EHelper(ret);</span><br></pre></td></tr></table></figure>
<h4 id="arith-c"><a href="#arith-c" class="headerlink" title="arith.c"></a>arith.c</h4><h5 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(add) &#123;</span><br><span class="line">  rtl_add(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  rtl_sltu(&amp;t0, &amp;t2, &amp;id_dest-&gt;val);</span><br><span class="line">  rtl_set_CF(&amp;t0);</span><br><span class="line"></span><br><span class="line">  rtl_xor(&amp;t0, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_not(&amp;t0);</span><br><span class="line">  rtl_xor(&amp;t1, &amp;id_dest-&gt;val, &amp;t2);</span><br><span class="line">  rtl_and(&amp;t0, &amp;t0, &amp;t1);</span><br><span class="line">  rtl_msb(&amp;t0, &amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_set_OF(&amp;t0);</span><br><span class="line">  print_asm_template2(add);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>i386</code>手册，<code>ADD</code>执行两个操作数（DEST和SRC）的整数相加。 加法结果被分配给第一个操作数（DEST），并相应地设置标志位，当立即字节被添加到字或双字操作数时，立即值被符号扩展为字或双字的大小的操作数，发现其与<code>Adc</code>相似，只需修改部分即可，然后填入<code>opcode table</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp1,</span><br><span class="line">    EX(add),....</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x00 */</span>  IDEXW(G2E, add, <span class="number">1</span>), IDEX(G2E, add), IDEXW(E2G, add, <span class="number">1</span>), IDEX(E2G, add),</span><br><span class="line"><span class="comment">/* 0x04 */</span>  IDEXW(I2a, add, <span class="number">1</span>), IDEX(I2a, add), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<blockquote>
<p>译码函数查询<code>decode.c</code>,同时对照<code>i386</code>手册填写即可，以下不在赘述</p>
</blockquote>
<h5 id="Sub"><a href="#Sub" class="headerlink" title="Sub"></a>Sub</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(sub) &#123;</span><br><span class="line">  rtl_sub(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  rtl_sltu(&amp;t0, &amp;id_dest-&gt;val, &amp;t2);</span><br><span class="line">  rtl_set_CF(&amp;t0);</span><br><span class="line"></span><br><span class="line">  rtl_xor(&amp;t0, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_xor(&amp;t1, &amp;id_dest-&gt;val, &amp;t2);</span><br><span class="line">  rtl_and(&amp;t0, &amp;t0, &amp;t1);</span><br><span class="line">  rtl_msb(&amp;t0, &amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_set_OF(&amp;t0);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(sub);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SUB</code>从第一个操作数（<code>DEST</code>）中减去第二个操作数（<code>SRC</code>）。 第一个操作数分配了相减的结果，并相应地设置标志。当从字操作数中减去一个立即字节值时，立即值首先被符号扩展为目标操作数的大小。根据<code>Add</code>指令相反的写<code>Sub</code>即可，也可以参考<code>Sbb</code>指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0x28 */</span>  IDEXW(G2E, sub, <span class="number">1</span>), IDEX(G2E, sub), IDEXW(E2G, sub, <span class="number">1</span>), IDEX(E2G, sub),</span><br><span class="line"><span class="comment">/* 0x2c */</span>  IDEXW(I2a, sub, <span class="number">1</span>), IDEX(I2a, sub), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h5 id="Cmp"><a href="#Cmp" class="headerlink" title="Cmp"></a>Cmp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(cmp) &#123;</span><br><span class="line">  rtl_sub(&amp;t0, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t0, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  rtl_sltu(&amp;t1, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_set_CF(&amp;t1);</span><br><span class="line"></span><br><span class="line">  rtl_xor(&amp;t0, &amp;id_dest-&gt;val, &amp;t0);</span><br><span class="line">  rtl_xor(&amp;t1, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_and(&amp;t0, &amp;t1, &amp;t0);</span><br><span class="line">  rtl_msb(&amp;t0, &amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_set_OF(&amp;t0);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(cmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Cmp</code>指令很简单，与<code>Sub</code>十分类似只是不需要写回，所以只要把<code>operand_write(id_dest, &amp;)</code>去掉即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp1,</span><br><span class="line">    EX(add), EX(<span class="keyword">or</span>), EX(adc), EX(sbb),</span><br><span class="line">    EX(<span class="keyword">and</span>), EX(sub), EX(xor), EX(cmp)）</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x38 */</span>  IDEXW(G2E, cmp, <span class="number">1</span>), IDEX(G2E, cmp), IDEXW(E2G, cmp, <span class="number">1</span>), IDEX(E2G, cmp),</span><br><span class="line"><span class="comment">/* 0x3c */</span>  IDEXW(I2a, cmp, <span class="number">1</span>), IDEX(I2a, cmp), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h5 id="Inc"><a href="#Inc" class="headerlink" title="Inc"></a>Inc</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(inc) &#123;</span><br><span class="line">  rtl_addi(&amp;t0, &amp;id_dest-&gt;val, <span class="number">1</span>);</span><br><span class="line">  operand_write(id_dest, &amp;t0);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_eqi(&amp;t1, &amp;id_dest-&gt;val, <span class="number">0xffffffff</span>);</span><br><span class="line">  rtl_set_CF(&amp;t1);</span><br><span class="line"></span><br><span class="line">  rtl_slt(&amp;t1, &amp;t0, &amp;id_dest-&gt;val);</span><br><span class="line">  rtl_set_OF(&amp;t1);</span><br><span class="line"></span><br><span class="line">  print_asm_template1(inc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>INC</code>在操作数上加1。 它不会更改进位标志。 要影响进位标志，请使用第二个操作数为1的<code>ADD</code>指令。解释很明确，使用<code>Addi</code>指令，然后更新标志位即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp4,</span><br><span class="line">    EX(inc), EX(dec), EMPTY, EMPTY,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x40 */</span>  IDEX(r, inc), IDEX(r, inc), IDEX(r, inc), IDEX(r, inc),</span><br><span class="line"><span class="comment">/* 0x44 */</span>  IDEX(r, inc), IDEX(r, inc), IDEX(r, inc), IDEX(r, inc),</span><br></pre></td></tr></table></figure>
<h5 id="Dec"><a href="#Dec" class="headerlink" title="Dec"></a>Dec</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(dec) &#123;</span><br><span class="line">  rtl_subi(&amp;t2, &amp;id_dest-&gt;val, <span class="number">1</span>);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  rtl_xor(&amp;t0, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_xor(&amp;t1, &amp;id_dest-&gt;val, &amp;t2);</span><br><span class="line">  rtl_and(&amp;t0, &amp;t0, &amp;t1);</span><br><span class="line">  rtl_msb(&amp;t0, &amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_set_OF(&amp;t0);</span><br><span class="line"></span><br><span class="line">  print_asm_template1(dec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DEC从操作数中减去1。 DEC不会更改进位标志。 要影响进位标志，请使用立即操作数为1的SUB指令。这里和上面的<code>Inc</code>类似，使用<code>subi</code>指令，然后照着<code>Inc</code>反着写<code>Dec</code>，更新标志位即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp4,</span><br><span class="line">    EX(inc), EX(dec), EMPTY, EMPTY,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x48 */</span>  IDEX(r, dec), IDEX(r, dec), IDEX(r, dec), IDEX(r, dec),</span><br><span class="line"><span class="comment">/* 0x4c */</span>  IDEX(r, dec), IDEX(r, dec), IDEX(r, dec), IDEX(r, dec),</span><br></pre></td></tr></table></figure>
<h5 id="Neg"><a href="#Neg" class="headerlink" title="Neg"></a>Neg</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(neg) &#123;</span><br><span class="line">  rtl_mv(&amp;t0, &amp;id_dest-&gt;val);</span><br><span class="line">  rtl_not(&amp;t0);</span><br><span class="line">  rtl_addi(&amp;t0, &amp;t0, <span class="number">1</span>);</span><br><span class="line">  operand_write(id_dest, &amp;t0);</span><br><span class="line"></span><br><span class="line">  rtl_eq0(&amp;t1, &amp;id_dest-&gt;val);</span><br><span class="line">  rtl_set_CF(&amp;t1);</span><br><span class="line"></span><br><span class="line">  rtl_update_ZFSF(&amp;t0, id_dest-&gt;width);</span><br><span class="line">  rtl_xor(&amp;t1, &amp;t0, &amp;id_dest-&gt;val);</span><br><span class="line">  rtl_not(&amp;t1);</span><br><span class="line">  rtl_msb(&amp;t1, &amp;t1, id_dest-&gt;width);</span><br><span class="line">  rtl_set_OF(&amp;t1);</span><br><span class="line"></span><br><span class="line">  print_asm_template1(neg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Neg</code>用其二进制补码替代寄存器或存储器操作数的值。操作数从零中减去，结果放在操作数中。进位标志被设置为1，除非操作数为零，在这种情况下，进位标志被清除为0。根据描述调用相应的<code>rtl</code>函数即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp3,</span><br><span class="line">    IDEX(test_I, test), EMPTY, EX(<span class="keyword">not</span>), EX(neg),</span><br><span class="line">    EX(mul), EX(imul1), EX(div), EX(idiv))</span><br></pre></td></tr></table></figure>
<h4 id="control-c"><a href="#control-c" class="headerlink" title="control.c"></a>control.c</h4><h5 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(ret) &#123;</span><br><span class="line">  rtl_pop(&amp;decoding.jmp_eip);</span><br><span class="line">  decoding.is_jmp = <span class="number">1</span>;</span><br><span class="line">  print_asm(<span class="string">"ret"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RET</code>将控制权转交给位于堆栈上的返回地址。地址通常由CALL指令放置在堆栈上，并返回到CALL之后的指令。简单来说就是把<code>jmp_eip</code>推出然后设置跳转即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0xc0 */</span>  IDEXW(gp2_Ib2E, gp2, <span class="number">1</span>), IDEX(gp2_Ib2E, gp2), EMPTY, EX(ret),</span><br></pre></td></tr></table></figure>
<h4 id="data-mov-c"><a href="#data-mov-c" class="headerlink" title="data-mov.c"></a>data-mov.c</h4><h5 id="leave"><a href="#leave" class="headerlink" title="leave"></a>leave</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(leave) &#123;</span><br><span class="line"> rtl_mv(&amp;cpu.esp, &amp;cpu.ebp);</span><br><span class="line"> rtl_pop(&amp;cpu.ebp);</span><br><span class="line"></span><br><span class="line">  print_asm(<span class="string">"leave"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LEAVE</code>反转<code>ENTER</code>指令的动作。通过将帧指针复制到堆栈指针，<code>LEAVE</code>释放过程为其局部变量使用的堆栈空间。旧的帧指针被弹出到BP或EBP中，恢复调用者的帧。 随后的RET指令将删除所有推送到退出过程堆栈上的参数。简单来说就是将<code>ebp</code>赋值给<code>esp</code>然后推出<code>ebp</code>，调用<code>rtl</code>函数直接完成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0xc8 */</span>  EMPTY, EX(leave), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h5 id="cltd"><a href="#cltd" class="headerlink" title="cltd"></a>cltd</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(cltd) &#123;</span><br><span class="line">  <span class="keyword">if</span> (decoding.is_operand_size_16) &#123;</span><br><span class="line">    rtl_lr(&amp;t0, R_AX, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int32_t</span>)(<span class="keyword">int16_t</span>)(<span class="keyword">uint16_t</span>)t0 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      rtl_addi(&amp;t1, &amp;tzero, <span class="number">0xffff</span>);</span><br><span class="line">      rtl_sr(R_DX, <span class="number">2</span>, &amp;t1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      rtl_sr(R_DX, <span class="number">2</span>, &amp;tzero);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    rtl_lr(&amp;t0, R_EAX, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int32_t</span>)t0 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      rtl_addi(&amp;t1, &amp;tzero, <span class="number">0xffffffff</span>);</span><br><span class="line">      rtl_sr(R_EDX, <span class="number">4</span>, &amp;t1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      rtl_sr(R_EDX, <span class="number">4</span>, &amp;tzero);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  print_asm(decoding.is_operand_size_16 ? <span class="string">"cwtl"</span> : <span class="string">"cltd"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CLD</code>清除方向标志。 没有其他标志或寄存器受到影响。 <code>CLD</code>执行后，字符串操作会增加它们使用的索引寄存器（<code>SI</code>和/或<code>DI</code>)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0x98 */</span>  EX(cwtl), EX(cltd), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h4 id="logic-c"><a href="#logic-c" class="headerlink" title="logic.c"></a>logic.c</h4><h5 id="test"><a href="#test" class="headerlink" title="test"></a>test</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(test) &#123;</span><br><span class="line">  rtl_and(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  rtl_set_CF(&amp;tzero);</span><br><span class="line">  rtl_set_OF(&amp;tzero);</span><br><span class="line">  rtl_update_ZFSF(&amp;t2,id_dest-&gt;width);</span><br><span class="line">  print_asm_template2(test);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TEST</code>计算其两个操作数的按位逻辑“与”。如果两个操作数的相应位都是1，结果为1; 否则，每一位都是0.操作的结果被丢弃，只有标志被修改。所以将两个操作数<code>and</code>之后仅设置标志位即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp3,</span><br><span class="line">    IDEX(test_I, test), EMPTY, EX(<span class="keyword">not</span>), EX(neg),</span><br><span class="line">    EX(mul), EX(imul1), EX(div), EX(idiv))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x84 */</span>  IDEXW(G2E, test ,<span class="number">1</span>), IDEX(G2E, test), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h5 id="and"><a href="#and" class="headerlink" title="and"></a>and</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(<span class="keyword">and</span>) &#123;</span><br><span class="line">  rtl_and(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line">  rtl_set_CF(&amp;tzero);</span><br><span class="line">  rtl_set_OF(&amp;tzero);</span><br><span class="line">  rtl_update_ZFSF(&amp;t2,id_dest-&gt;width);</span><br><span class="line">  print_asm_template2(<span class="keyword">and</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果操作数的两个相应位都是1，AND指令的结果的每一位都是1; 否则，它变成0。与<code>Test</code>类似，只需添加将结果写回即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp1,</span><br><span class="line">    EX(add), EX(<span class="keyword">or</span>), EX(adc), EX(sbb),</span><br><span class="line">    EX(<span class="keyword">and</span>), EX(sub), EX(xor), EX(cmp))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x20 */</span>  IDEXW(G2E, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(G2E, <span class="keyword">and</span>), IDEXW(E2G, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(E2G, <span class="keyword">and</span>),</span><br><span class="line"><span class="comment">/* 0x24 */</span>  IDEXW(I2a, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(I2a, <span class="keyword">and</span>), EMPTY, EMPTY,</span><br></pre></td></tr></table></figure>
<h5 id="or"><a href="#or" class="headerlink" title="or"></a>or</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(<span class="keyword">or</span>) &#123;</span><br><span class="line">  rtl_or(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line">  rtl_set_CF(&amp;tzero);</span><br><span class="line">  rtl_set_OF(&amp;tzero);</span><br><span class="line">  rtl_update_ZFSF(&amp;id_dest-&gt;val,id_dest-&gt;width);</span><br><span class="line">  print_asm_template2(xor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OR计算其两个操作数的包含OR，并将结果放入第一个操作数中。 如果操作数的相应位都是0，结果的每一位都是0; 否则，每一位都是1。与<code>And</code>指令相同，只需将<code>rtl_and</code>修改为<code>rtl_or</code>即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp1,</span><br><span class="line">    EX(add), EX(<span class="keyword">or</span>), EX(adc), EX(sbb),</span><br><span class="line">    EX(<span class="keyword">and</span>), EX(sub), EX(xor), EX(cmp))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x08 */</span>  IDEXW(G2E, <span class="keyword">or</span>, <span class="number">1</span>), IDEX(G2E, <span class="keyword">or</span>), IDEXW(E2G, <span class="keyword">or</span>, <span class="number">1</span>), IDEX(E2G, <span class="keyword">or</span>),</span><br></pre></td></tr></table></figure>
<h5 id="sar"><a href="#sar" class="headerlink" title="sar"></a>sar</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(sar) &#123;</span><br><span class="line">  <span class="comment">// unnecessary to update CF and OF in NEMU</span></span><br><span class="line">  rtl_sar(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(sar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SAR</code>向下移动操作数的位。低阶位移入进位标志。<code>SAR</code>执行有符号的分割，向负无穷大舍入（与<code>IDIV</code>不同; 高位保持不变。先判断操作数宽度进行扩展，然后调用<code>rtl_sar</code>函数，将结果写回并更新符号位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(shr) &#123;</span><br><span class="line">  <span class="comment">// unnecessary to update CF and OF in NEMU</span></span><br><span class="line">  rtl_shr(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(shr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SHR</code>与<code>SAR</code>类似,<code>SHR</code>执行未标记的划分; 高位被设置为0。写法与<code>Sar</code>类似，调用<code>rtl_shr</code>函数后写回，更新标志位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(shl) &#123;</span><br><span class="line">  <span class="comment">// unnecessary to update CF and OF in NEMU</span></span><br><span class="line">  rtl_shl(&amp;t2, &amp;id_dest-&gt;val, &amp;id_src-&gt;val);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line">  rtl_update_ZFSF(&amp;t2, id_dest-&gt;width);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(shl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SAL</code>(或其同义词<code>SHL</code>）向上移动操作数的位。 高位移入进位标志，低位设为0。与上面两个指令类似，调用<code>rtl_shl</code>函数，将结果写回，更新标志位</p>
<blockquote>
<p>以上三个函数根据提示不需要更新<code>CF</code>和<code>OF</code>位</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make_group(gp2,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">    EX(shl), EX(shr), EMPTY, EX(sar))</span><br></pre></td></tr></table></figure>
<h5 id="setcc"><a href="#setcc" class="headerlink" title="setcc"></a>setcc</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(setcc) &#123;</span><br><span class="line">  <span class="keyword">uint8_t</span> subcode = decoding.opcode &amp; <span class="number">0xf</span>;</span><br><span class="line">  rtl_setcc(&amp;t2, subcode);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line"></span><br><span class="line">  print_asm(<span class="string">"set%s %s"</span>, get_cc_name(subcode), id_dest-&gt;str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里可以看到调用了<code>rtl_setcc</code>，我们要去<code>cc.c</code>文件中对指令进行补全</p>
<h4 id="cc-c"><a href="#cc-c" class="headerlink" title="cc.c"></a>cc.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (subcode &amp; <span class="number">0xe</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> CC_O:</span><br><span class="line">    rtl_li(dest, cpu.eflags.OF);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_B:</span><br><span class="line">    rtl_li(dest, cpu.eflags.CF);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_E:</span><br><span class="line">    rtl_get_ZF(&amp;t0);</span><br><span class="line">    rtl_eqi(dest, &amp;t0, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_NE:</span><br><span class="line">    rtl_get_ZF(&amp;t0);</span><br><span class="line">    rtl_neq0(dest, &amp;t0);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_BE:</span><br><span class="line">    rtl_li(dest, ((cpu.eflags.CF) || (cpu.eflags.ZF)));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_S:</span><br><span class="line">    rtl_li(dest, cpu.eflags.SF);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_L:</span><br><span class="line">    rtl_li(dest, (cpu.eflags.SF != cpu.eflags.OF));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CC_LE:&#123;</span><br><span class="line">    rtl_li(dest, ((cpu.eflags.ZF) || (cpu.eflags.SF != cpu.eflags.OF)));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">default</span>: panic(<span class="string">"should not reach here"</span>);</span><br><span class="line">  <span class="keyword">case</span> CC_P: panic(<span class="string">"n86 does not have PF"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里根据<code>i386</code>补全了部分需要用到的指令:</p>
<ul>
<li><code>CC_O</code>: 将<code>OF</code>赋值给操作数</li>
<li><code>CC_B</code>: 将<code>CF</code>赋值给操作数</li>
<li><code>CC_E</code>: 获取<code>ZF</code>, 然后判断<code>ZF</code>是否为<code>1</code>，若是则<code>dest</code>为<code>1</code>，否则为<code>0</code></li>
<li><code>CC_NE</code>: 获取<code>ZF</code>, 然后判断<code>ZF</code>是否不等于<code>0</code>，若是则<code>dest</code>为<code>1</code>，否则为<code>0</code></li>
<li><code>CC_BE</code>: 将<code>CF</code>和<code>ZF</code>取或后结果赋值给<code>dest</code></li>
<li><code>CC_S</code>: 将<code>SF</code>赋值给操作数</li>
<li><code>CC_L</code>: 判断<code>SF</code>和<code>OF</code>是否相等，将结果赋值给<code>dest</code></li>
<li><code>CC_LE</code>: 将<code>ZF</code>和<code>SF</code>是否不等于<code>OF</code>的结果取或，然后赋值给<code>dest</code></li>
</ul>
<p>最后附上完整的<code>exec</code>文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0x80, 0x81, 0x83 */</span></span><br><span class="line">make_group(gp1,</span><br><span class="line">    EX(add), EX(<span class="keyword">or</span>), EX(adc), EX(sbb),</span><br><span class="line">    EX(<span class="keyword">and</span>), EX(sub), EX(xor), EX(cmp))</span><br><span class="line"><span class="comment">/* 0xc0, 0xc1, 0xd0, 0xd1, 0xd2, 0xd3 */</span></span><br><span class="line">make_group(gp2,</span><br><span class="line">    EX(rol), EMPTY, EMPTY, EMPTY,</span><br><span class="line">    EX(shl), EX(shr), EMPTY, EX(sar))</span><br><span class="line"><span class="comment">/* 0xf6, 0xf7 */</span></span><br><span class="line">make_group(gp3,</span><br><span class="line">    IDEX(test_I, test), EMPTY, EX(<span class="keyword">not</span>), EX(neg),</span><br><span class="line">    EX(mul), EX(imul1), EX(div), EX(idiv))</span><br><span class="line"><span class="comment">/* 0xfe */</span></span><br><span class="line">make_group(gp4,</span><br><span class="line">    EX(inc), EX(dec), EMPTY, EMPTY,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0xff */</span></span><br><span class="line">make_group(gp5,</span><br><span class="line">    EXW(inc, <span class="number">2</span>), EX(dec), EX(call_rm), EX(call),</span><br><span class="line">    EX(jmp_rm), EMPTY, EX(push), EMPTY)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0x0f 0x01*/</span></span><br><span class="line">make_group(gp7,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">    EMPTY, EMPTY, EMPTY, EMPTY)</span><br><span class="line"></span><br><span class="line">opcode_entry opcode_table [<span class="number">512</span>] = &#123;</span><br><span class="line">  <span class="comment">/* 0x00 */</span>  IDEXW(G2E, add, <span class="number">1</span>), IDEX(G2E, add), IDEXW(E2G, add, <span class="number">1</span>), IDEX(E2G, add),</span><br><span class="line">  <span class="comment">/* 0x04 */</span>  IDEXW(I2a, add, <span class="number">1</span>), IDEX(I2a, add), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x08 */</span>  IDEXW(G2E, <span class="keyword">or</span>, <span class="number">1</span>), IDEX(G2E, <span class="keyword">or</span>), IDEXW(E2G, <span class="keyword">or</span>, <span class="number">1</span>), IDEX(E2G, <span class="keyword">or</span>),</span><br><span class="line">  <span class="comment">/* 0x0c */</span>  IDEXW(I2a, <span class="keyword">or</span>, <span class="number">1</span>), IDEX(I2a, <span class="keyword">or</span>), EMPTY, EX(<span class="number">2b</span>yte_esc),</span><br><span class="line">  <span class="comment">/* 0x10 */</span>  IDEXW(G2E, adc, <span class="number">1</span>), IDEX(G2E, adc), IDEXW(E2G, adc, <span class="number">1</span>), IDEX(E2G, adc),</span><br><span class="line">  <span class="comment">/* 0x14 */</span>  IDEXW(I2a, adc, <span class="number">1</span>), IDEX(I2a, adc), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x18 */</span>  IDEXW(G2E, sbb, <span class="number">1</span>), IDEX(G2E, sbb), IDEXW(E2G, sbb, <span class="number">1</span>), IDEX(E2G, sbb),</span><br><span class="line">  <span class="comment">/* 0x1c */</span>  IDEXW(I2a, sbb, <span class="number">1</span>), IDEX(I2a, sbb), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x20 */</span>  IDEXW(G2E, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(G2E, <span class="keyword">and</span>), IDEXW(E2G, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(E2G, <span class="keyword">and</span>),</span><br><span class="line">  <span class="comment">/* 0x24 */</span>  IDEXW(I2a, <span class="keyword">and</span>, <span class="number">1</span>), IDEX(I2a, <span class="keyword">and</span>), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x28 */</span>  IDEXW(G2E, sub, <span class="number">1</span>), IDEX(G2E, sub), IDEXW(E2G, sub, <span class="number">1</span>), IDEX(E2G, sub),</span><br><span class="line">  <span class="comment">/* 0x2c */</span>  IDEXW(I2a, sub, <span class="number">1</span>), IDEX(I2a, sub), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x30 */</span>  IDEX(G2E, xor), IDEX(G2E, xor), IDEX(E2G, xor), IDEX(E2G, xor),</span><br><span class="line">  <span class="comment">/* 0x34 */</span>  IDEX(I2a, xor), IDEX(I2r, xor), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x38 */</span>  IDEXW(G2E, cmp, <span class="number">1</span>), IDEX(G2E, cmp), IDEXW(E2G, cmp, <span class="number">1</span>), IDEX(E2G, cmp),</span><br><span class="line">  <span class="comment">/* 0x3c */</span>  IDEXW(I2a, cmp, <span class="number">1</span>), IDEX(I2a, cmp), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x40 */</span>  IDEX(r, inc), IDEX(r, inc), IDEX(r, inc), IDEX(r, inc),</span><br><span class="line">  <span class="comment">/* 0x44 */</span>  IDEX(r, inc), IDEX(r, inc), IDEX(r, inc), IDEX(r, inc),</span><br><span class="line">  <span class="comment">/* 0x48 */</span>  IDEX(r, dec), IDEX(r, dec), IDEX(r, dec), IDEX(r, dec),</span><br><span class="line">  <span class="comment">/* 0x4c */</span>  IDEX(r, dec), IDEX(r, dec), IDEX(r, dec), IDEX(r, dec),</span><br><span class="line">  <span class="comment">/* 0x50 */</span>  IDEX(r, push), IDEX(r, push), IDEX(r, push), IDEX(r, push),</span><br><span class="line">  <span class="comment">/* 0x54 */</span>  IDEX(r, push), IDEX(r, push), IDEX(r, push), IDEX(r, push),</span><br><span class="line">  <span class="comment">/* 0x58 */</span>  IDEX(r, pop), IDEX(r, pop), IDEX(r, pop), IDEX(r, pop),</span><br><span class="line">  <span class="comment">/* 0x5c */</span>  IDEX(r, pop), IDEX(r, pop), IDEX(r, pop), IDEX(r, pop),</span><br><span class="line">  <span class="comment">/* 0x60 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x64 */</span>  EMPTY, EMPTY, EX(operand_size), EMPTY,</span><br><span class="line">  <span class="comment">/* 0x68 */</span>  IDEX(push_SI, push), EMPTY, IDEXW(push_SI, push, <span class="number">1</span>), EMPTY,</span><br><span class="line">  <span class="comment">/* 0x6c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x70 */</span>  IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x74 */</span>  IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x78 */</span>  IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x7c */</span>  IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>), IDEXW(J, jcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x80 */</span>  IDEXW(I2E, gp1, <span class="number">1</span>), IDEX(I2E, gp1), EMPTY, IDEX(SI2E, gp1),</span><br><span class="line">  <span class="comment">/* 0x84 */</span>  IDEXW(G2E, test ,<span class="number">1</span>), IDEX(G2E, test), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x88 */</span>  IDEXW(mov_G2E, mov, <span class="number">1</span>), IDEX(mov_G2E, mov), IDEXW(mov_E2G, mov, <span class="number">1</span>), IDEX(mov_E2G, mov),</span><br><span class="line">  <span class="comment">/* 0x8c */</span>  EMPTY, IDEX(lea_M2G, lea), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x90 */</span>  EX(nop), EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x94 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x98 */</span>  EX(cwtl), EX(cltd), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x9c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xa0 */</span>  IDEXW(O2a, mov, <span class="number">1</span>), IDEX(O2a, mov), IDEXW(a2O, mov, <span class="number">1</span>), IDEX(a2O, mov),</span><br><span class="line">  <span class="comment">/* 0xa4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xa8 */</span>  IDEXW(I2a, test, <span class="number">1</span>), IDEX(I2a, test), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xac */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xb0 */</span>  IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0xb4 */</span>  IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>), IDEXW(mov_I2r, mov, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0xb8 */</span>  IDEX(mov_I2r, mov), IDEX(mov_I2r, mov), IDEX(mov_I2r, mov), IDEX(mov_I2r, mov),</span><br><span class="line">  <span class="comment">/* 0xbc */</span>  IDEX(mov_I2r, mov), IDEX(mov_I2r, mov), IDEX(mov_I2r, mov), IDEX(mov_I2r, mov),</span><br><span class="line">  <span class="comment">/* 0xc0 */</span>  IDEXW(gp2_Ib2E, gp2, <span class="number">1</span>), IDEX(gp2_Ib2E, gp2), EMPTY, EX(ret),</span><br><span class="line">  <span class="comment">/* 0xc4 */</span>  EMPTY, EMPTY, IDEXW(mov_I2E, mov, <span class="number">1</span>), IDEX(mov_I2E, mov),</span><br><span class="line">  <span class="comment">/* 0xc8 */</span>  EMPTY, EX(leave), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xcc */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xd0 */</span>  IDEXW(gp2_1_E, gp2, <span class="number">1</span>), IDEX(gp2_1_E, gp2), IDEXW(gp2_cl2E, gp2, <span class="number">1</span>), IDEX(gp2_cl2E, gp2),</span><br><span class="line">  <span class="comment">/* 0xd4 */</span>  EMPTY, EMPTY, EX(nemu_trap), EMPTY,</span><br><span class="line">  <span class="comment">/* 0xd8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xdc */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe8 */</span>  IDEX(I, call), IDEX(J, jmp), EMPTY, IDEXW(J, jmp, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0xec */</span>  IDEXW(in_dx2a, in, <span class="number">1</span>), IDEX(in_dx2a, in), IDEXW(out_a2dx, out, <span class="number">1</span>), IDEX(out_a2dx, out),</span><br><span class="line">  <span class="comment">/* 0xf0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xf4 */</span>  EMPTY, EMPTY, IDEXW(E, gp3, <span class="number">1</span>), IDEX(E, gp3),</span><br><span class="line">  <span class="comment">/* 0xf8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xfc */</span>  EMPTY, EMPTY, IDEXW(E, gp4, <span class="number">1</span>), IDEX(E, gp5),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*2 byte_opcode_table */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 0x00 */</span>  EMPTY, IDEX(gp7_E, gp7), EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x04 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x08 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x0c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x10 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x14 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x18 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x1c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x20 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x24 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x28 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x2c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x30 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x34 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x38 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x3c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x40 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x44 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x48 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x4c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x50 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x54 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x58 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x5c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x60 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x64 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x68 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x6c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x70 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x74 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x78 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x7c */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0x80 */</span>  IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc),</span><br><span class="line">  <span class="comment">/* 0x84 */</span>  IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc),</span><br><span class="line">  <span class="comment">/* 0x88 */</span>  IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc),</span><br><span class="line">  <span class="comment">/* 0x8c */</span>  IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc), IDEX(J, jcc),</span><br><span class="line">  <span class="comment">/* 0x90 */</span>  IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x94 */</span>  IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x98 */</span>  IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0x9c */</span>  IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>), IDEXW(E, setcc, <span class="number">1</span>),</span><br><span class="line">  <span class="comment">/* 0xa0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xa4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xa8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xac */</span>  EMPTY, EMPTY, EMPTY, IDEX(E2G, imul2),</span><br><span class="line">  <span class="comment">/* 0xb0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xb4 */</span>  EMPTY, EMPTY, IDEXW(mov_E2G, movzx, <span class="number">1</span>), IDEXW(mov_E2G, movzx, <span class="number">2</span>),</span><br><span class="line">  <span class="comment">/* 0xb8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xbc */</span>  EMPTY, EMPTY, IDEXW(mov_E2G, movsx, <span class="number">1</span>), IDEXW(mov_E2G, movsx, <span class="number">2</span>),</span><br><span class="line">  <span class="comment">/* 0xc0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xc4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xc8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xcc */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xd0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xd4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xd8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xdc */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xe8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xec */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xf0 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xf4 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xf8 */</span>  EMPTY, EMPTY, EMPTY, EMPTY,</span><br><span class="line">  <span class="comment">/* 0xfc */</span>  EMPTY, EMPTY, EMPTY, EMPTY</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="基础设置-2"><a href="#基础设置-2" class="headerlink" title="基础设置(2)"></a>基础设置(2)</h3><h5 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h5><blockquote>
<p>Differential Testing能帮你节省多少时间呢?</p>
</blockquote>
<p>能节省我至少10个小时</p>
<h4 id="Differential-Testing"><a href="#Differential-Testing" class="headerlink" title="Differential Testing"></a>Differential Testing</h4><p>先在<code>nemu/include/common.h</code>中定义<code>DIFF_TEST</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIFF_TEST</span></span><br></pre></td></tr></table></figure>
<p>然后在<code>nemu/src/monitor/diff-test/diff-test.c</code>文件中的<code>difftest_step</code>函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(cpu.eip != r.eip)&#123;</span><br><span class="line">  diff = <span class="literal">true</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"eip: nemu: 0x%x qemu: 0x%x \n"</span>,cpu.eip,r.eip);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">8</span> ; i++)&#123;</span><br><span class="line">  <span class="keyword">if</span>(reg_l(i) != r.<span class="built_in">array</span>[i])&#123;</span><br><span class="line">    diff = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: nemu: 0x%x qemu: 0x%x \n"</span>,regsl[i],reg_l(i),r.<span class="built_in">array</span>[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对<code>eip</code>和八个寄存器进行遍历比较，如果发现值不同则设置<code>diff = true</code>停止客户程序运行</p>
<h4 id="一键回归测试"><a href="#一键回归测试" class="headerlink" title="一键回归测试"></a>一键回归测试</h4><p>在<code>nemu</code>目录执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash runall.sh</span><br></pre></td></tr></table></figure>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.2-runall.png" alt=""></p>
<p>全部样例跑通</p>
<h5 id="思考题-1"><a href="#思考题-1" class="headerlink" title="思考题"></a>思考题</h5><blockquote>
<p>你觉得该如何捕捉死循环</p>
</blockquote>
<p>对程序设置最大运行时间，如果超过该时间则判断程序进入死循环</p>
<h2 id="PA2-3-输入输出"><a href="#PA2-3-输入输出" class="headerlink" title="PA2.3 输入输出"></a>PA2.3 输入输出</h2><h5 id="思考题-2"><a href="#思考题-2" class="headerlink" title="思考题"></a>思考题</h5><blockquote>
<p>如果代码中的地址<code>0x8049000</code>最终被映射到一个设备寄存器，去掉<code>volatile</code>可能会带来什么问题?</p>
</blockquote>
<p>变量如果加了 <code>volatile</code> 修饰，则会从内存重新装载内容，而不是直接从寄存器拷贝内容，去掉<code>volatile</code>会导致错误发生</p>
<h4 id="实现Hello-World"><a href="#实现Hello-World" class="headerlink" title="实现Hello World"></a>实现Hello World</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(in) &#123;</span><br><span class="line">  t2 = pio_read(id_src-&gt;val, id_src-&gt;width);</span><br><span class="line">  operand_write(id_dest, &amp;t2);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(in);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DIFF_TEST</span></span><br><span class="line">  diff_test_skip_qemu();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">make_EHelper(out) &#123;</span><br><span class="line">  pio_write(id_dest-&gt;val, id_dest-&gt;width, id_src-&gt;val);</span><br><span class="line"></span><br><span class="line">  print_asm_template2(out);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DIFF_TEST</span></span><br><span class="line">  diff_test_skip_qemu();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>in</code>与<code>out</code>类似，分别调用<code>pio_read</code>和<code>pio_write</code>函数并传入相应参数即可，这里设置了<code>is_skip_qemu</code>标志来跳过<code>QEMU</code>检查，完成指令后在<code>all-instr.h</code>中定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make_EHelper(rol);</span><br><span class="line">make_EHelper(out);</span><br></pre></td></tr></table></figure>
<p>在<code>exec.c</code>中填写<code>opcode table</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 0xec */</span>  IDEXW(in_dx2a, in, <span class="number">1</span>), IDEX(in_dx2a, in), IDEXW(out_a2dx, out, <span class="number">1</span>), IDEX(out_a2dx, out),</span><br></pre></td></tr></table></figure>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-hello.png" alt=""></p>
<h4 id="时钟"><a href="#时钟" class="headerlink" title="时钟"></a>时钟</h4><p>在<code>nexus-am/am/arch/x86-nemu/src/ioe.c</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _ioe_init() &#123;</span><br><span class="line">  boot_time = inl(RTC_PORT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> _uptime() &#123;</span><br><span class="line">  <span class="keyword">return</span> inl(RTC_PORT) - boot_time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出<code>inl(RTC_PORT)</code>获取当前时间，<code>boot_time</code>为上一次时间，将两者相减返回即可</p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-time.png" alt=""></p>
<h4 id="看看NEMU跑多快"><a href="#看看NEMU跑多快" class="headerlink" title="看看NEMU跑多快"></a>看看NEMU跑多快</h4><p><strong>Dhrystone</strong></p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-test1.png" alt=""></p>
<p><strong>Coremark</strong></p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-test2.png" alt=""></p>
<p><strong>Microbench</strong></p>
<p><code>ref</code>测试</p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-test3.png" alt=""></p>
<p><code>test</code>测试</p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-test-s.png" alt=""></p>
<h4 id="键盘"><a href="#键盘" class="headerlink" title="键盘"></a>键盘</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> _read_key() &#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> key_code = _KEY_NONE;</span><br><span class="line">  <span class="keyword">if</span>(inb(I8042_STATUS_PORT))&#123;</span><br><span class="line">    key_code = inl(I8042_DATA_PORT);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> key_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里先判断端口<code>I8042_STATUS_PORT</code>是否开启，若开启则获取当前<code>keycode</code>即<code>inl(I8042_DATA_PORT)</code>，否则返回<code>_KEY_NONE</code></p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-key.png" alt=""></p>
<h5 id="思考题-3"><a href="#思考题-3" class="headerlink" title="思考题"></a>思考题</h5><blockquote>
<p>如何检测多个键被同时按下？</p>
</blockquote>
<p>当检测到一个键被按下的时候，去检测此时其他是否有按键被按下</p>
<blockquote>
<p>在一些90年代的游戏中，很多渐入渐出的效果都是通过调色板实现的，聪明的你知道其中的玄机么？</p>
</blockquote>
<p>将颜色模拟成类似透明的白色盖在其他颜色上面，模拟出渐变的颜色</p>
<h4 id="添加内存映射I-O"><a href="#添加内存映射I-O" class="headerlink" title="添加内存映射I/O"></a>添加内存映射I/O</h4><p>在<code>nemu/src/memory/memory.c</code>文件中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> paddr_read(<span class="keyword">paddr_t</span> addr, <span class="keyword">int</span> len) &#123;</span><br><span class="line">  <span class="keyword">int</span> port = is_mmio(addr);</span><br><span class="line">  <span class="keyword">if</span>(port != <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> mmio_read(addr, len, port);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pmem_rw(addr, <span class="keyword">uint32_t</span>) &amp; (~<span class="number">0u</span> &gt;&gt; ((<span class="number">4</span> - len) &lt;&lt; <span class="number">3</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">paddr_write</span><span class="params">(<span class="keyword">paddr_t</span> addr, <span class="keyword">int</span> len, <span class="keyword">uint32_t</span> data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> port = is_mmio(addr);</span><br><span class="line">  <span class="keyword">if</span>(port != <span class="number">-1</span>)&#123;</span><br><span class="line">    mmio_write(addr, len, data, port);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(guest_to_host(addr), &amp;data, len);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先用<code>is_mmio</code>函数判断物理地址是否被映射到<code>I/O</code>空间，对于<code>paddr_read</code>若返回<code>-1</code>则访问<code>pmem</code>，否则使用<code>mmio_read</code>函数读取<code>port</code>位置的内存，对于<code>paddr_write</code>，若不返回<code>-1</code>则调用<code>mmio_write</code>将数据写入<code>port</code>位置内存</p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-vga.png" alt=""></p>
<h4 id="实现IOE-3"><a href="#实现IOE-3" class="headerlink" title="实现IOE(3)"></a>实现IOE(3)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _draw_rect(<span class="keyword">const</span> <span class="keyword">uint32_t</span> *pixels, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> w, <span class="keyword">int</span> h) &#123;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; h; i++) &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(fb + (y + i) * _screen.width + x, pixels + i * w, w * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将<code>pixels</code>指定的的矩形像素绘制到屏幕中以<code>(x, y)</code>和<code>(x+w, y+h)</code>两点连线为对角线的矩形区域</p>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/pa2.3-type.png" alt=""></p>
<h4 id="必答题"><a href="#必答题" class="headerlink" title="必答题"></a>必答题</h4><h5 id="编译与链接"><a href="#编译与链接" class="headerlink" title="编译与链接"></a>编译与链接</h5><blockquote>
<p>去掉<code>static</code>，去掉<code>inline</code>或去掉两者，然后重新进行编译，你会发现错误，请分别解释为什么会发生这些错误？你有办法证明你的想法么</p>
</blockquote>
<p>当函数被声明<code>static</code>后，<strong>它只在定义它的源文件内有效，其他源文件无法访问</strong>，所以用来解决不同文件函数重名问题，如果去掉进行编译的话，若不同文件有相同函数名则会报错，<strong>证明</strong>可以将不同文件中的函数名里添加文件名进行区分，若不报错则想法正确</p>
<p><code>inline</code>修饰的函数变为内联函数,同时和<code>static</code>类似，只有本地文件可见，允许多个文件内重复定义相同名的函数，错误与<code>static</code>类似，可能会报重复定义的错误，<strong>证明</strong>可以将不同文件中的函数名里添加文件名进行区分，若不报错则想法正确</p>
<h5 id="编译与链接-1"><a href="#编译与链接-1" class="headerlink" title="编译与链接"></a>编译与链接</h5><blockquote>
<p>在<code>nemu/include/common.h</code>中添加<code>volatile static int dummy;</code>后重新编译<code>NEMU</code>,请问重新编译后的<code>NEMU</code>有多少个<code>dummy</code>变量的实体，你是如何得到这个结果的</p>
</blockquote>
<p>有1个。因为在这里用<code>volatile</code>定义了一个<code>dummy</code></p>
<blockquote>
<p>在上一问题条件下在<code>nemu/include/debug.h</code>中添加<code>volatile static int dummy;</code>,请问重新编译后的<code>NEMU</code>有多少个<code>dummy</code>变量的实体，与上题中<code>dummy</code>实体数目进行比较，并解释本题的结果</p>
</blockquote>
<p>有2个。因为两个文件中都使用了<code>volatile</code>进行<code>dummy</code>的定义，所以不会发生冲突，为2个。</p>
<blockquote>
<p>修改添加的代码，为两处<code>dummy</code>变量进行初始化<code>volatile static int dummy = 0;</code>,然后重新编译<code>NEMU</code>,你发现了什么问题？为什么之前没有出现这个问题</p>
</blockquote>
<p>会报错。因为当<code>volatile</code>修饰的<code>dummy</code>被赋予了确定的值之后，两个<code>dummy</code>就指向了同一个内存地址，会发生重复定义的错误。</p>
<h5 id="了解Makefile"><a href="#了解Makefile" class="headerlink" title="了解Makefile"></a>了解Makefile</h5><blockquote>
<p>请你描述在<code>nemu</code>目录下敲入<code>make</code>后，<code>make</code>程序如何组织<code>.c</code>和<code>.h</code>文件，最终生成可执行文件<code>nemu/build/nemu</code>(这个问题包含两个方面: <code>makefile</code>的工作方式和编译链接的过程)</p>
</blockquote>
<ul>
<li>在当前目录下找名字叫<code>Makefile</code>或<code>makefile</code>的文件</li>
<li>如果找到，它会找文件中的第一个目标文件，并把这个文件作为最终的目标文件</li>
<li>如果文件不存在，或是文件所依赖的后面的<code>.o</code>文件的文件修改时间要比这个文件新，那么，他就会执行后面所定义的命令来生成h这个文件，这个也就是重编译</li>
<li>如果文件所依赖的<code>.o</code>文件也存在，那么<code>make</code>会在当前文件中找目标为<code>.o</code>文件的依赖性，如果找到则再根据那一个规则生成<code>.o</code>文件。</li>
<li><code>.c</code>文件和<code>.h</code>文件存在，于是<code>make</code>会生成 <code>.o</code> 文件</li>
<li><code>make</code>会一层一层去找文件的依赖关系，直到最终编译出第一个目标文件，若是过程中出现了错误，<code>make</code>会直接退出并报错，直到最后生成可执行文件<code>nemu</code></li>
</ul>
<p><img src="http://p5sf6v0wz.bkt.clouddn.com/Pa2-3log.png" alt=""></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">AddOneG</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/05/06/ICS2017-Programming-Assignment-2-2-2-3/">http://yoursite.com/2018/05/06/ICS2017-Programming-Assignment-2-2-2-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/学习/">学习</a><a class="post-meta__tags" href="/tags/C/">C</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/06/从“零”开始-：Spring-MVC/"><i class="fa fa-chevron-left">  </i><span>从“零”开始 ：Spring MVC</span></a></div><div class="next-post pull-right"><a href="/2018/05/05/计算机组成-程序的转换及机器级表示/"><span>计算机组成-程序的转换及机器级表示</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By AddOneG</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>
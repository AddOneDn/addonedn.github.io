<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="纯前端实现Gif制作"><meta name="keywords" content="HTML,JS"><meta name="author" content="AddOneG,undefined"><meta name="copyright" content="AddOneG"><title>纯前端实现Gif制作 | AddOneG</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.3"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  localSearch: undefined
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始操作"><span class="toc-number">2.</span> <span class="toc-text">开始操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Begin"><span class="toc-number">2.1.</span> <span class="toc-text">Begin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Next"><span class="toc-number">2.2.</span> <span class="toc-text">Next</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Next-Result"><span class="toc-number">2.3.</span> <span class="toc-text">Next Result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再Next"><span class="toc-number">2.4.</span> <span class="toc-text">再Next</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再Next-Result"><span class="toc-number">2.5.</span> <span class="toc-text">再Next Result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#真正开始操作"><span class="toc-number">2.6.</span> <span class="toc-text">真正开始操作~</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">2.7.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="http://p5sf6v0wz.bkt.clouddn.com/avatar.jpg"></div><div class="author-info__name text-center">AddOneG</div><div class="author-info__description text-center">我本嘉宾，何惧无笙</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">38</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">29</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">21</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://blog.triplez.cn/" target="_blank">TripleZ</a><a class="author-info-links__name text-center" href="http://karlrixon.link/" target="_blank">karlrixon</a><a class="author-info-links__name text-center" href="http://qrzbing.cn/" target="_blank">a-Lie-Z</a><a class="author-info-links__name text-center" href="https://primykq.top/" target="_blank">Primykq</a><a class="author-info-links__name text-center" href="https://blog.zeddyu.info/" target="_blank">Zedd</a><a class="author-info-links__name text-center" href="https://yuwenjie.cc/" target="_blank">Seiry</a><a class="author-info-links__name text-center" href="https://mountainlovers.github.io/" target="_blank">Mountain_lovers</a><a class="author-info-links__name text-center" href="https://blog.rexskz.info/" target="_blank">Rex</a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">AddOneG</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">时间轴</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">纯前端实现Gif制作</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-03-24</time><span class="post-meta__separator">|</span><i class="fa fa-inbox" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Javascript/"> Javascript</a><span class="post-meta__separator">|</span><span class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1,131</span><span class="post-meta__separator">|</span><span>Reading time: 4 min</span></span></div><div id="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>受<a href="https://sorry.xuty.tk/sorry/" target="_blank" rel="noopener">在线Sorry动图制作</a>启发，想自己用纯前端撸一个类似的东西出来，这里<a href="http://04ke.cn:8888/index.html" target="_blank" rel="noopener">地址</a></p>
<h2 id="开始操作"><a href="#开始操作" class="headerlink" title="开始操作"></a>开始操作</h2><h3 id="Begin"><a href="#Begin" class="headerlink" title="Begin"></a>Begin</h3><p>开始没有任何头绪，想着去别人源码那copy一下，发现根本用不上…</p>
<h3 id="Next"><a href="#Next" class="headerlink" title="Next"></a>Next</h3><ul>
<li><strong>想法1</strong>: 用绝对定位将文字定位到gif上,然后根据gif特定时间点显示特定文字</li>
<li><strong>想法2</strong>: 在特定的时间点上用canvas在gif上绘制特定的文字</li>
</ul>
<h3 id="Next-Result"><a href="#Next-Result" class="headerlink" title="Next Result"></a>Next Result</h3><p>想了想，上面两种想法很好实现，但是都只是把动图展示出来，不能把修改后的文字保存到gif里</p>
<h3 id="再Next"><a href="#再Next" class="headerlink" title="再Next"></a>再Next</h3><p>对gif的每一帧进行处理然后再拼成gif</p>
<h3 id="再Next-Result"><a href="#再Next-Result" class="headerlink" title="再Next Result"></a>再Next Result</h3><p>想了想，没什么大问题，那就开干吧</p>
<h3 id="真正开始操作"><a href="#真正开始操作" class="headerlink" title="真正开始操作~"></a>真正开始操作~</h3><p>怎么把处理后的图片拼接成gif是个问题，去google了一波发现gif.js这个玩意，api也很简单，把图片或者canvas传进去然后render一下就ojbk了,来个官方demo</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gif = <span class="keyword">new</span> GIF(&#123;</span><br><span class="line">  workers: <span class="number">2</span>,</span><br><span class="line">  quality: <span class="number">10</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add a image element</span></span><br><span class="line">gif.addFrame(imageElement);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or a canvas element</span></span><br><span class="line">gif.addFrame(canvasElement, &#123;<span class="attr">delay</span>: <span class="number">200</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or copy the pixels from a canvas context</span></span><br><span class="line">gif.addFrame(ctx, &#123;<span class="attr">copy</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line">gif.on(<span class="string">'finished'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">blob</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.open(URL.createObjectURL(blob));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gif.render();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>至于如何获得gif的每一帧，我用的mac下的Gif preview</p>
</blockquote>
<p>用户点击生成后用类似懒加载的方式加载图片</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span> ; i &lt; num ; i++)&#123;</span><br><span class="line">  image = <span class="keyword">new</span> Image()</span><br><span class="line">  image.src = <span class="string">`xxxx<span class="subst">$&#123;i&#125;</span>/xx.jpg`</span></span><br><span class="line">  arr[i] = image</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>请求数据量比较大，我先用mac下的Compress All对图片进行压缩，然后再用gzip进一步压缩所有文件(这都是后话了)</p>
</blockquote>
<p>接下来调用canvas的drawImage，绘制arr图片数组中的图片，然后用canvas在上面绘制文字，注意绘制的过程使用函数<strong>requestAnimationFrame</strong>(这坑爬了好久)，关于此函数这里就不讲解了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  ctx.drawImage(arr[i],<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">  ......</span><br><span class="line">  requestAnimationFrame(render)</span><br><span class="line">&#125;</span><br><span class="line">render()</span><br></pre></td></tr></table></figure>
<p>然后一个循环把canvas都add进去</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span> ; j &lt; num ; j++)&#123;     </span><br><span class="line">  gif.addFrame(ctx,&#123;<span class="attr">delay</span>: <span class="number">167</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里注意这两块代码执行的顺序，按照正常理解是draw一个add一个但是我发现不行(woc为什么?)，改了半天破罐破摔都draw完后再一股脑add进去发现竟然可以(???)…</p>
<ul>
<li>我打印了一下执行顺序发现add竟然是在draw之前完成的<blockquote>
<p>因为draw是递归调用，并且draw和add都是同步任务，按照Js单线程来看draw了一次后就轮到add的for循环执行，执行完毕后才会执行递归调用的draw</p>
</blockquote>
</li>
</ul>
<p>那么问题来了… 递归调用的draw还没执行，为什么for循环里就能把没绘制的元素状态”add”进去… 于是我看了一波源码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GIF.prototype.addFrame = <span class="function"><span class="keyword">function</span>(<span class="params">image, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> frame, key;</span><br><span class="line">  <span class="keyword">if</span> (options == <span class="literal">null</span>) &#123;</span><br><span class="line">      options = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  frame = &#123;&#125;;</span><br><span class="line">  frame.transparent = <span class="keyword">this</span>.options.transparent;</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> frameDefaults) &#123;</span><br><span class="line">      frame[key] = options[key] || frameDefaults[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.options.width == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setOption(<span class="string">"width"</span>, image.width)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.options.height == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setOption(<span class="string">"height"</span>, image.height)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> ImageData !== <span class="string">"undefined"</span> &amp;&amp; ImageData !== <span class="literal">null</span> &amp;&amp; image <span class="keyword">instanceof</span> ImageData) &#123;</span><br><span class="line">      frame.data = image.data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> CanvasRenderingContext2D !== <span class="string">"undefined"</span> &amp;&amp; CanvasRenderingContext2D !== <span class="literal">null</span> &amp;&amp; image <span class="keyword">instanceof</span> CanvasRenderingContext2D || <span class="keyword">typeof</span> WebGLRenderingContext !== <span class="string">"undefined"</span> &amp;&amp; WebGLRenderingContext !== <span class="literal">null</span> &amp;&amp; image <span class="keyword">instanceof</span> WebGLRenderingContext) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.copy) &#123;</span><br><span class="line">          frame.data = <span class="keyword">this</span>.getContextData(image)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          frame.context = image</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (image.childNodes != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.copy) &#123;</span><br><span class="line">          frame.data = <span class="keyword">this</span>.getImageData(image)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          frame.image = image</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid image"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.frames.push(frame)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>instanceof 运算符用来测试一个对象在其原型链中是否存在一个构造函数的 prototype 属性</p>
</blockquote>
<p>很明显, 因为add时候参数没有传<code>copy</code>所以进入<code>frame.context = image</code>，看到context第一感觉是和执行上下文有关系，再打印一遍执行顺序发现<code>gif.on(&#39;finish&#39;)</code>是全部draw完后执行的，结合worker不难推出frame和canvas之间是类似引用的关系并且在子线程中不断执行…</p>
<p>最后就很简单了…render一下就ojbk</p>
<blockquote>
<p>考虑到我服务器性能和网速… 我在这整个大函数外面套了个延时器…保证用户加载完图片后才开始drawImage，不然会报错</p>
</blockquote>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>服务器使用node.js的express搭建</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>光是最后这个想法介绍起来都能看出来我踩了很多坑….之前的想法踩了多少坑就不提了23333，并且发现不对后整个代码都要重写emmm，不过收获还是很多，同样的问题不会犯第二次了</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">AddOneG</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/03/24/纯前端实现gif制作/">http://yoursite.com/2018/03/24/纯前端实现gif制作/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HTML/">HTML</a><a class="post-meta__tags" href="/tags/JS/">JS</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/03/25/Parcel上手与React开发环境搭建/"><i class="fa fa-chevron-left">  </i><span>Parcel上手与React开发环境搭建</span></a></div><div class="next-post pull-right"><a href="/2018/03/23/CSS人人都能写自定义Checkbox（-1白话讲解）/"><span>CSS人人都能写自定义Checkbox（+1白话讲解）</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By AddOneG</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.3"></script><script src="/js/fancybox.js?version=1.5.3"></script><script src="/js/sidebar.js?version=1.5.3"></script><script src="/js/copy.js?version=1.5.3"></script><script src="/js/fireworks.js?version=1.5.3"></script><script src="/js/transition.js?version=1.5.3"></script><script src="/js/scroll.js?version=1.5.3"></script><script src="/js/head.js?version=1.5.3"></script></body></html>